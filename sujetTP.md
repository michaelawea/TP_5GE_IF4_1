# INSA Lyon – 5GE(A) – IF4/5 2024-2025

# 实时编程TP，IF4

## 第3次课，TP1，计算机实验室工作

---

## 目录

1. 引言
   - 1.1 开发环境配置
   - 1.2 实验报告
2. 实验课
   - 2.1 并发任务
     - 2.1.1 第一次尝试
     - 2.1.2 两个并发任务，变体
   - 2.2 周期性任务
     - 2.2.1 第一种方法
     - 2.2.2 第二种方法
   - 2.3 任务间同步
     - 2.3.1 原理
     - 2.3.2 实验1
     - 2.3.3 实验2
     - 2.3.4 实验3
   - 2.4 中断
   - 2.5 任务间通信
   - 2.6 同步

---

## 1 引言

本次实验课的目标是熟悉ESP32微控制器上FreeRTOS提供的实时多任务机制。

### 1.1 开发环境配置

请参考moodle上提供的课程准备文档。

### 1.2 实验报告

需要提交手写实验报告，在实验课后一周内提交。这份报告对TP2很有用，而且在考试当天也会用到，因为考试会涉及你在TP中完成的内容。教师还会评估你的工作准备情况和TP期间的进度。

---

## 2 实验课

启动Arduino开发环境v2（程序在v1上无法运行）：

- 打开终端（CTRL+ALT+T），然后输入：
  ```
  /opt/arduino-ide_2.3.2_Linux_64bit/arduino-ide
  ```

- 或者在"TP1实验课文件"中下载Arduino2.desktop文件，保存到桌面并双击。如果提示文件不可执行，点击"仍然启动"。

---

## 2.1 并发任务

### 2.1.1 第一次尝试

**要执行的程序：** IF4_TP1_Q21a.ino

1. 简要描述程序实现的功能和在示波器上获得的结果。解释为什么会得到这个结果。

2. 打开串口监视器，你观察到了什么？为什么？

### 2.1.2 两个并发任务，变体

**要执行的程序：** IF4_TP1_Q21b.ino

1. 与前一个程序有什么区别？

2. 通过示波器和串口监视器观察，对运行有什么影响？

3. 如何避免这个问题？

4. 修改两个任务的优先级，将它们设置为相同的值。你观察到了什么？

---

## 2.2 周期性任务

### 2.2.1 第一种方法

**要执行的程序：** IF4_TP1_Q22a.ino

1. 与前一个程序有什么区别？

2. 任务1和任务2获得的周期是多少？解释原因。

3. 如果强制两个任务在同一个核心上运行，会发生什么？

4. 预期周期是否得到遵守？这是获得周期性任务的好方法吗？

### 2.2.2 第二种方法

**要执行的程序：** IF4_TP1_Q22b.ino

1. 与前一个程序有什么区别？

2. 任务1和任务2获得的周期是多少？解释原因。

3. 如果强制两个任务在同一个核心上运行，会发生什么？

4. 逐步增加nb_iterations以延长两个任务的工作时间。会发生什么？

5. 什么标准可以预测这个问题？

---

## 2.3 任务间同步

### 2.3.1 原理

- **二进制信号量**用于同步两个任务：一个任务等待另一个任务给它"绿灯"才能启动。

- **互斥锁（Mutex，互斥排除）**：专门用于保护共享资源访问的特殊信号量。

  它允许优先级继承：当多个任务请求获取互斥锁时，互斥锁持有者的优先级会临时设置为等待释放的任务中最高优先级的值。这种技术可以防止第一次课程中看到的优先级反转现象，尽管这并不能保证对这些现象的绝对安全防护。

### 2.3.2 实验1

**要执行的程序：** IF4_TP1_Q23a.ino

解释程序做了什么以及如何实现的。

### 2.3.3 实验2

**要执行的程序：** IF4_TP1_Q23b.ino

1. 解释程序做了什么（使用示波器和串口控制台）。

2. 什么地方工作不正常？

3. 取消第57-58行、65-66行、92-93行、100-101行的注释。解释发生了什么？

### 2.3.4 实验3

**要执行的程序：** IF4_TP_Q23c.ino

1. 解释程序做了什么。

2. 在第168行，将 `xSemaphore = xSemaphoreCreateBinary();` 替换为 `xSemaphore = xSemaphoreCreateMutex();`。解释区别是什么？

   分析差异。

---

## 2.4 中断

**要执行的程序：** IF4_TP1_Q24.ino

解释程序做了什么（使用示波器和串口控制台）。

---

## 2.5 任务间通信

**要执行的程序：** IF4_TP1_Q25.ino

1. 解释程序做了什么（使用示波器和串口控制台）。

2. 从网页ESP32+FreeRTOS获取示例程序#7。让它运行，修改任务参数并进行评论。

---

## 2.6 同步

编写一个程序来组织3个任务之间的会合点：

a. 第一个任务执行一项工作；

b. 第二个任务并行执行另一项工作；

c. 第三个任务必须等待前两个任务完成后才能启动。

**提示：** http://www.openrtos.net/uxSemaphoreGetCount.html 和/或使用xSemaphoreCreateCounting创建可计数的信号量（非必需）

---

## 如果您已完成TP1，请开始TP2

---

**参考链接：** http://tvaira.free.fr/esp32/esp32-freertos.html